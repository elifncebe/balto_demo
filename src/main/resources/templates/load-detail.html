<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle != null ? pageTitle + ' - Balto' : 'Load Details - Balto'}">Load Details - Balto</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#151326',
                        'primary-dark': '#0D0C18',
                        'primary-light': '#2E294E',
                        accent: '#6A5ACD',
                        'accent-light': '#8A4FFF',
                        secondary: '#2E294E',
                        success: '#4CAF50',
                        warning: '#FF9800',
                        danger: '#F44336',
                        light: '#F5F5F7',
                        dark: '#0D0C18',
                        gray: '#9E9E9E',
                        'lavender': '#E6E6FA',
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-primary {
                @apply bg-accent hover:bg-accent-light text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out;
            }
            .btn-success {
                @apply bg-success hover:bg-success/80 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/80 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out;
            }
            .btn-sm {
                @apply py-1 px-3 text-sm;
            }
            .badge {
                @apply inline-block px-3 py-1 text-xs font-semibold rounded-full shadow-sm;
            }
            .badge-new {
                @apply bg-accent text-white;
            }
            .badge-in-progress {
                @apply bg-warning text-white;
            }
            .badge-completed {
                @apply bg-success text-white;
            }
            .badge-cancelled {
                @apply bg-danger text-white;
            }
            .form-input {
                @apply w-full px-4 py-3 border border-lavender rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent bg-light/50 text-primary transition duration-200 ease-in-out;
            }
            .form-label {
                @apply block text-primary font-medium mb-2;
            }
            .form-group {
                @apply mb-4;
            }
            .message-sent {
                @apply bg-accent text-white rounded-lg p-3 max-w-md ml-auto shadow-sm;
            }
            .message-received {
                @apply bg-lavender/30 text-primary rounded-lg p-3 max-w-md mr-auto border border-lavender/50 shadow-sm;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-lavender to-light min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold">Balto</h1>
                <p class="ml-3 text-lavender">Shipping that matters</p>
            </div>
            <div class="flex items-center">
                <span class="mr-4" sec:authentication="name">Username</span>
                <a href="/logout" class="text-white hover:text-lavender transition">Logout</a>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8">
                <a href="/dashboard" class="py-4 px-2 text-gray-500 font-semibold hover:text-accent">
                    Dashboard
                </a>
                <a href="/loads/new" class="py-4 px-2 text-gray-500 font-semibold hover:text-accent">
                    Create Load
                </a>
                <a href="/analytics" class="py-4 px-2 text-gray-500 font-semibold hover:text-accent">
                    Analytics
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <div class="flex items-center text-sm text-gray-500 mb-6">
            <a href="/dashboard" class="hover:text-primary">Dashboard</a>
            <span class="mx-2">›</span>
            <span class="text-gray-700" th:text="${viewingAllMessages ? 'All Messages' : 'Load Details'}">Load Details</span>
        </div>
        
        <!-- Load Details - Only shown when not viewing all messages -->
        <div th:if="${!viewingAllMessages}" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-secondary" th:text="${'Load ' + load.id}">Load L-12345</h2>
                    <div class="mt-2">
                        <span th:if="${load.status == 'NEW'}" class="badge badge-new">New</span>
                        <span th:if="${load.status == 'IN_PROGRESS'}" class="badge badge-in-progress">In Progress</span>
                        <span th:if="${load.status == 'COMPLETED'}" class="badge badge-completed">Completed</span>
                        <span th:if="${load.status == 'CANCELLED'}" class="badge badge-cancelled">Cancelled</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <a th:href="@{/loads/{id}/edit(id=${load.id})}" class="btn-secondary btn-sm">
                        Edit
                    </a>
                    <form th:if="${load.status != 'COMPLETED'}" th:action="@{/loads/{id}/resolve(id=${load.id})}" method="post">
                        <button type="submit" class="btn-success btn-sm">Mark as Resolved</button>
                    </form>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3">Customer Information</h3>
                    <div class="space-y-2">
                        <p><span class="font-medium">Name:</span> <span th:text="${load.customerName}">John Doe</span></p>
                        <p><span class="font-medium">Email:</span> <span th:text="${load.customerEmail}">john@example.com</span></p>
                        <p><span class="font-medium">Phone:</span> <span th:text="${load.customerPhone}">555-123-4567</span></p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">Load Information</h3>
                    <div class="space-y-2">
                        <p><span class="font-medium">Created:</span> <span th:text="${#temporals.format(load.createdAt, 'MMM dd, yyyy HH:mm')}">Aug 3, 2025 14:30</span></p>
                        <p><span class="font-medium">Broker:</span> <span th:text="${load.brokerName}">Jane Smith</span></p>
                        <p><span class="font-medium">VIN Count:</span> <span th:text="${load.vinCount}">3</span></p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">Pickup Information</h3>
                    <div class="space-y-2">
                        <p><span class="font-medium">Address:</span> <span th:text="${load.pickupAddress}">123 Main St, Chicago, IL</span></p>
                        <p><span class="font-medium">Date:</span> <span th:text="${#temporals.format(load.pickupDate, 'MMM dd, yyyy')}">Aug 10, 2025</span></p>
                        <p><span class="font-medium">Time:</span> <span th:text="${load.pickupTime}">9:00 AM - 12:00 PM</span></p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">Delivery Information</h3>
                    <div class="space-y-2">
                        <p><span class="font-medium">Address:</span> <span th:text="${load.deliveryAddress}">456 Oak St, Detroit, MI</span></p>
                        <p><span class="font-medium">ETA:</span> <span th:text="${#temporals.format(load.deliveryEta, 'MMM dd, yyyy')}">Aug 15, 2025</span></p>
                        <p><span class="font-medium">Notes:</span> <span th:text="${load.deliveryNotes}">Call upon arrival</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VIN List - Only shown when not viewing all messages -->
        <div th:if="${!viewingAllMessages}" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-bold text-secondary mb-4">Vehicle Information</h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                VIN
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Make
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Model
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Year
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Color
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- If no VINs, show empty state -->
                        <tr th:if="${#lists.isEmpty(load.vins)}">
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                No vehicles found for this load.
                            </td>
                        </tr>
                        
                        <!-- VIN items -->
                        <tr th:each="vin : ${load.vins}" class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium text-gray-900" th:text="${vin.vinNumber}">1HGCM82633A123456</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" th:text="${vin.make}">Honda</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" th:text="${vin.model}">Accord</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" th:text="${vin.year}">2023</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" th:text="${vin.color}">Black</span>
                            </td>
                        </tr>
                        
                        <!-- Example VINs for demonstration (will be replaced by actual data) -->
                        <tr th:if="${#lists.isEmpty(load.vins)}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium text-gray-900">1HGCM82633A123456</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">Honda</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">Accord</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">2023</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">Black</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(load.vins)}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium text-gray-900">5YJSA1E29MF123456</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">Tesla</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">Model S</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">2021</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">White</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- All Messages Header - Only shown when viewing all messages -->
        <div th:if="${viewingAllMessages && !viewingSingleMessage}" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-secondary">All Messages</h2>
            <p class="text-gray-600 mt-1">View and manage all messages across all loads</p>
        </div>
        
        <!-- Single Message Header - Only shown when viewing a single message -->
        <div th:if="${viewingSingleMessage}" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-secondary" th:text="${'Message #' + messageId}">Message #123</h2>
            <p class="text-gray-600 mt-1">Viewing a specific message</p>
            <div class="mt-4">
                <a href="/messages" class="btn-secondary btn-sm">
                    Back to All Messages
                </a>
            </div>
        </div>
        
        <!-- Messaging Thread -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-secondary">Messages</h3>
                <button id="view-all-messages" class="text-accent hover:text-accent-light font-medium flex items-center">
                    <span>View all messages</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- Message Thread -->
            <div id="message-thread" class="space-y-4 mb-6 max-h-96 overflow-y-auto p-2">
                <!-- If no messages, show empty state -->
                <div th:if="${#lists.isEmpty(messages)}" class="text-center text-gray-500 py-8">
                    No messages yet. Start the conversation below.
                </div>
                
                <!-- Message items -->
                <div th:each="message : ${messages}" class="flex flex-col">
                    <div th:class="${message.sentByCurrentUser ? 'message-sent' : 'message-received'}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm" th:text="${message.senderName}">John Doe</span>
                            <span class="text-xs opacity-75" th:text="${#temporals.format(message.timestamp, 'MMM dd, HH:mm')}">Aug 3, 14:30</span>
                        </div>
                        <p th:text="${message.content}">Hello, I wanted to check on the status of this load.</p>
                        <div class="flex items-center mt-1 text-xs">
                            <span th:text="${message.channelType}">SMS</span>
                            <span class="mx-1">•</span>
                            <span th:text="${message.deliveryStatus}">Delivered</span>
                        </div>
                    </div>
                </div>
                
                <!-- Example messages for demonstration (will be replaced by actual data) -->
                <div th:if="${#lists.isEmpty(messages)}" class="flex flex-col">
                    <div class="message-received">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm">John Doe</span>
                            <span class="text-xs opacity-75">Aug 3, 14:30</span>
                        </div>
                        <p>Hello, I wanted to check on the status of this load.</p>
                        <div class="flex items-center mt-1 text-xs">
                            <span>SMS</span>
                            <span class="mx-1">•</span>
                            <span>Delivered</span>
                        </div>
                    </div>
                </div>
                
                <div th:if="${#lists.isEmpty(messages)}" class="flex flex-col">
                    <div class="message-sent">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm">You</span>
                            <span class="text-xs opacity-75">Aug 3, 14:35</span>
                        </div>
                        <p>The load is currently in transit and on schedule for delivery on August 15th.</p>
                        <div class="flex items-center mt-1 text-xs">
                            <span>Email</span>
                            <span class="mx-1">•</span>
                            <span>Delivered</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compose Box - Only shown when viewing a specific load -->
            <form th:if="${!viewingAllMessages}" th:action="@{/loads/{id}/message(id=${load.id})}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="message" class="form-label">New Message</label>
                    <textarea id="message" name="content" rows="3" class="form-input" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label for="channel" class="form-label">Channel</label>
                        <select id="channel" name="channelType" class="form-input">
                            <option value="EMAIL">Email</option>
                            <option value="SMS">SMS</option>
                            <option value="IN_APP" selected>In-App</option>
                        </select>
                    </div>
                    
                    <div class="form-group md:col-span-2">
                        <label for="attachment" class="form-label">Attachment (optional)</label>
                        <input type="file" id="attachment" name="attachment" class="form-input pt-1">
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary">
                        Send Message
                    </button>
                </div>
            </form>
            
            <!-- Message form when viewing all messages -->
            <form th:if="${viewingAllMessages && !viewingSingleMessage}" th:action="@{/messages/send}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="general-message" class="form-label">New Message</label>
                    <textarea id="general-message" name="content" rows="3" class="form-input" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label for="general-channel" class="form-label">Channel</label>
                        <select id="general-channel" name="channelType" class="form-input">
                            <option value="EMAIL">Email</option>
                            <option value="SMS">SMS</option>
                            <option value="IN_APP" selected>In-App</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="general-recipient" class="form-label">Recipient (optional)</label>
                        <input type="text" id="general-recipient" name="recipient" class="form-input" placeholder="Enter recipient name or ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="general-attachment" class="form-label">Attachment (optional)</label>
                        <input type="file" id="general-attachment" name="attachment" class="form-input pt-1">
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary">
                        Send Message
                    </button>
                </div>
            </form>
            
            <!-- Message when viewing a single message -->
            <div th:if="${viewingSingleMessage}" class="mt-6 p-4 bg-lavender/30 rounded-lg border border-lavender text-center">
                <p class="text-secondary">You are viewing a single message. To send a new message, please go to all messages.</p>
                <a href="/messages" class="btn-primary inline-block mt-2">View All Messages</a>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-primary text-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center items-center mb-4">
                <h2 class="text-2xl font-bold">Balto</h2>
                <span class="mx-3 text-accent">•</span>
                <p class="text-lavender">Shipping that matters</p>
            </div>
            <p class="mb-2">Balto Logistics Management System v0.1</p>
            <p class="text-lavender text-sm">
                <a href="/api/health" class="text-lavender hover:text-white transition mx-2">API Status</a>
                <a href="/hello" class="text-lavender hover:text-white transition mx-2">Hello Endpoint</a>
                <a href="/terminate" class="text-lavender hover:text-white transition mx-2">Terminate Application</a>
            </p>
        </div>
    </footer>
    
    <!-- JavaScript for "View all messages" functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const viewAllMessagesBtn = document.getElementById('view-all-messages');
            const messageThread = document.getElementById('message-thread');
            let expanded = false;
            
            viewAllMessagesBtn.addEventListener('click', function() {
                if (expanded) {
                    // Collapse the message thread
                    messageThread.classList.remove('max-h-full');
                    messageThread.classList.add('max-h-96');
                    viewAllMessagesBtn.querySelector('span').textContent = 'View all messages';
                } else {
                    // Expand the message thread
                    messageThread.classList.remove('max-h-96');
                    messageThread.classList.add('max-h-full');
                    viewAllMessagesBtn.querySelector('span').textContent = 'Show less';
                }
                expanded = !expanded;
            });
        });
    </script>
</body>
</html>